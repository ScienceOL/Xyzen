# Novu notification infrastructure overlay for sciol-infra
# Usage: docker compose -p sciol-infra -f docker-compose.infra.yaml -f docker-compose.novu.yaml up
#
# Fully independent stack: own MongoDB, own Redis, own network-service.
# Xyzen containers reach Novu API via host.docker.internal:3100 (cross-project)
# or via the bridge network if running in the same compose project.
#
# Host port mapping:
#   3100 → Novu API    (internal 3000)
#   3102 → Novu WS     (internal 3002)
#   4200 → Novu Dashboard (internal 4000)

services:
  novu-network-service:
    image: alpine:3.22
    ports:
      - "${NOVU_API_PORT:-3100}:3000"
      - "${NOVU_WS_PORT:-3102}:3002"
      - "${NOVU_DASHBOARD_PORT:-4200}:4000"
    command: tail -f /dev/null
    networks:
      - sciol-network

  novu-mongodb:
    image: mongo:8
    network_mode: "service:novu-network-service"
    restart: unless-stopped
    attach: false
    environment:
      MONGO_INITDB_ROOT_USERNAME: novu
      MONGO_INITDB_ROOT_PASSWORD: novu
    volumes:
      - novu-mongo-data:/data/db
    healthcheck:
      test:
        [
          "CMD",
          "mongosh",
          "--quiet",
          "-u",
          "novu",
          "-p",
          "novu",
          "--eval",
          "db.adminCommand('ping').ok",
        ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s

  novu-redis:
    image: redis:7-alpine
    network_mode: "service:novu-network-service"
    restart: unless-stopped
    attach: false
    command: redis-server --port 6380 --appendonly yes
    volumes:
      - novu-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6380", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  novu-api:
    image: ghcr.io/novuhq/novu/api:3.11.0
    network_mode: "service:novu-network-service"
    restart: unless-stopped
    attach: false
    depends_on:
      novu-mongodb:
        condition: service_healthy
      novu-redis:
        condition: service_healthy
    environment:
      NODE_ENV: local
      PORT: 3000
      API_ROOT_URL: http://localhost:${NOVU_API_PORT:-3100}
      FRONT_BASE_URL: http://localhost:${NOVU_DASHBOARD_PORT:-4200}
      MONGO_URL: mongodb://novu:novu@127.0.0.1:27017/novu-db?authSource=admin
      MONGO_MIN_POOL_SIZE: 5
      MONGO_MAX_POOL_SIZE: 10
      MONGO_AUTO_CREATE_INDEXES: "true"
      REDIS_HOST: "127.0.0.1"
      REDIS_PORT: 6380
      REDIS_PASSWORD: ""
      REDIS_DB_INDEX: 2
      REDIS_CACHE_SERVICE_HOST: "127.0.0.1"
      REDIS_CACHE_SERVICE_PORT: 6380
      S3_LOCAL_STACK: ""
      S3_BUCKET_NAME: novu-local
      S3_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      JWT_SECRET: ${NOVU_JWT_SECRET:-novu-dev-jwt-secret-change-in-production}
      STORE_ENCRYPTION_KEY: ${NOVU_STORE_ENCRYPTION_KEY:-novu_dev_encryption_key_32chars!}
      NOVU_SECRET_KEY: ${NOVU_SECRET_KEY:-novu-dev-secret-key-change-in-production}
      SUBSCRIBER_WIDGET_JWT_EXPIRATION_TIME: 15d
      IS_API_IDEMPOTENCY_ENABLED: "false"
      IS_API_RATE_LIMITING_ENABLED: "false"
      IS_NEW_MESSAGES_API_RESPONSE_ENABLED: "true"
      IS_V2_ENABLED: "true"
      API_CONTEXT_PATH: ""
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:3000/v1/health-check || exit 1",
        ]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 40s

  novu-worker:
    image: ghcr.io/novuhq/novu/worker:3.11.0
    network_mode: "service:novu-network-service"
    restart: unless-stopped
    attach: false
    depends_on:
      novu-mongodb:
        condition: service_healthy
      novu-redis:
        condition: service_healthy
    environment:
      NODE_ENV: local
      PORT: 3004
      MONGO_URL: mongodb://novu:novu@127.0.0.1:27017/novu-db?authSource=admin
      MONGO_MAX_POOL_SIZE: 10
      REDIS_HOST: "127.0.0.1"
      REDIS_PORT: 6380
      REDIS_PASSWORD: ""
      REDIS_DB_INDEX: 2
      REDIS_CACHE_SERVICE_HOST: "127.0.0.1"
      REDIS_CACHE_SERVICE_PORT: 6380
      S3_LOCAL_STACK: ""
      S3_BUCKET_NAME: novu-local
      S3_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      STORE_ENCRYPTION_KEY: ${NOVU_STORE_ENCRYPTION_KEY:-novu_dev_encryption_key_32chars!}
      SUBSCRIBER_WIDGET_JWT_EXPIRATION_TIME: 15d
      BROADCAST_QUEUE_CHUNK_SIZE: 100
      MULTICAST_QUEUE_CHUNK_SIZE: 100
      API_ROOT_URL: http://127.0.0.1:3000
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:3004/v1/health-check || exit 1",
        ]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 20s

  novu-ws:
    image: ghcr.io/novuhq/novu/ws:3.11.0
    network_mode: "service:novu-network-service"
    restart: unless-stopped
    attach: false
    depends_on:
      novu-mongodb:
        condition: service_healthy
      novu-redis:
        condition: service_healthy
    environment:
      PORT: 3002
      NODE_ENV: local
      MONGO_URL: mongodb://novu:novu@127.0.0.1:27017/novu-db?authSource=admin
      MONGO_MAX_POOL_SIZE: 10
      REDIS_HOST: "127.0.0.1"
      REDIS_PORT: 6380
      REDIS_PASSWORD: ""
      JWT_SECRET: ${NOVU_JWT_SECRET:-novu-dev-jwt-secret-change-in-production}
      WS_CONTEXT_PATH: ""
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:3002/v1/health-check || exit 1",
        ]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 40s

  novu-dashboard:
    image: ghcr.io/novuhq/novu/dashboard:3.11.0
    network_mode: "service:novu-network-service"
    restart: unless-stopped
    attach: false
    depends_on:
      novu-api:
        condition: service_healthy
      novu-worker:
        condition: service_healthy
    environment:
      VITE_API_HOSTNAME: http://localhost:${NOVU_API_PORT:-3100}
      VITE_SELF_HOSTED: "true"
      VITE_WEBSOCKET_HOSTNAME: http://localhost:${NOVU_WS_PORT:-3102}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:4000/ || exit 1",
        ]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 20s

volumes:
  novu-mongo-data:
    driver: local
  novu-redis-data:
    driver: local

networks:
  sciol-network:
    driver: bridge
