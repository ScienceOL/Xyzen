# Daytona sandbox services overlay for sciol-infra
# Usage: docker compose -p sciol-infra -f docker-compose.infra.yaml -f docker-compose.daytona.yaml up
#
# All services share a single network namespace via daytona-network-service (same pattern as
# sciol-infra and sciol-xyzen). Internal communication uses localhost.
# Xyzen containers reach Daytona API via host.docker.internal (cross-project).
#
# Environment-specific notes:
# - Mac/OrbStack: host.docker.internal resolves automatically
# - k8s: replace with k8s service URLs (e.g., daytona-api.daytona.svc:3000)

services:
  daytona-network-service:
    image: alpine:3.22
    ports:
      - '${DAYTONA_API_PORT:-13000}:3000'
      - '${DAYTONA_PROXY_PORT:-14000}:4000'
      # Dex OIDC — uncomment only if you need Dashboard login.
      # With DAYTONA_ADMIN_API_KEY set, Dashboard login is not required.
      # - '${DAYTONA_DEX_PORT:-15556}:5556'
      # - '${DAYTONA_RUNNER_PORT:-13003}:3003'
      # - '${DAYTONA_SSH_PORT:-12222}:2222'
      # - '${DAYTONA_REGISTRY_PORT:-16000}:6000'
      # - '${DAYTONA_MINIO_CONSOLE_PORT:-19001}:9001'
    command: tail -f /dev/null
    networks:
      - daytona-network

  daytona-api:
    image: daytonaio/daytona-api
    network_mode: 'service:daytona-network-service'
    environment:
      - ADMIN_API_KEY=${DAYTONA_ADMIN_API_KEY:-xyzen-dev-admin-key}
      - ADMIN_TOTAL_CPU_QUOTA=10000
      - ADMIN_TOTAL_MEMORY_QUOTA=10000
      - ADMIN_TOTAL_DISK_QUOTA=100000
      - ADMIN_MAX_CPU_PER_SANDBOX=100
      - ADMIN_MAX_MEMORY_PER_SANDBOX=100
      - ADMIN_MAX_DISK_PER_SANDBOX=1000
      - ADMIN_SNAPSHOT_QUOTA=1000
      - ADMIN_MAX_SNAPSHOT_SIZE=1000
      - ADMIN_VOLUME_QUOTA=10000
      - OTEL_ENABLED=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
      - DEFAULT_SNAPSHOT=daytonaio/sandbox:0.5.0-slim
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=localhost
      - DB_PORT=5432
      - DB_USERNAME=user
      - DB_PASSWORD=pass
      - DB_DATABASE=daytona
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - OIDC_CLIENT_ID=daytona
      - OIDC_ISSUER_BASE_URL=http://localhost:5556/dex
      - PUBLIC_OIDC_DOMAIN=http://localhost:${DAYTONA_DEX_PORT:-15556}/dex
      - OIDC_AUDIENCE=daytona
      - OIDC_MANAGEMENT_API_ENABLED=
      - OIDC_MANAGEMENT_API_CLIENT_ID=
      - OIDC_MANAGEMENT_API_CLIENT_SECRET=
      - OIDC_MANAGEMENT_API_AUDIENCE=
      - DASHBOARD_URL=http://localhost:${DAYTONA_API_PORT:-13000}/dashboard
      - DASHBOARD_BASE_API_URL=http://localhost:${DAYTONA_API_PORT:-13000}
      - POSTHOG_API_KEY=
      - POSTHOG_HOST=
      - POSTHOG_ENVIRONMENT=local
      - TRANSIENT_REGISTRY_URL=http://localhost:6000
      - TRANSIENT_REGISTRY_ADMIN=admin
      - TRANSIENT_REGISTRY_PASSWORD=password
      - TRANSIENT_REGISTRY_PROJECT_ID=daytona
      - INTERNAL_REGISTRY_URL=http://localhost:6000
      - INTERNAL_REGISTRY_ADMIN=admin
      - INTERNAL_REGISTRY_PASSWORD=password
      - INTERNAL_REGISTRY_PROJECT_ID=daytona
      - SMTP_HOST=
      - SMTP_PORT=
      - SMTP_USER=
      - SMTP_PASSWORD=
      - SMTP_SECURE=
      - S3_ENDPOINT=http://localhost:9000
      - S3_STS_ENDPOINT=http://localhost:9000/minio/v1/assume-role
      - S3_REGION=us-east-1
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_DEFAULT_BUCKET=daytona
      - S3_ACCOUNT_ID=/
      - S3_ROLE_NAME=/
      - ENVIRONMENT=docker-compose
      - MAX_AUTO_ARCHIVE_INTERVAL=43200
      - MAINTENANCE_MODE=false
      - PROXY_DOMAIN=host.docker.internal:${DAYTONA_PROXY_PORT:-14000}
      - PROXY_PROTOCOL=http
      - PROXY_API_KEY=${DAYTONA_PROXY_SECRET:-super_secret_key}
      - PROXY_TEMPLATE_URL=http://{{PORT}}-{{sandboxId}}.host.docker.internal:${DAYTONA_PROXY_PORT:-14000}
      - DEFAULT_RUNNER_DOMAIN=localhost:3003
      - DEFAULT_RUNNER_API_URL=http://localhost:3003
      - DEFAULT_RUNNER_PROXY_URL=http://localhost:3003
      - DEFAULT_RUNNER_API_KEY=${DAYTONA_RUNNER_SECRET:-secret_api_token}
      - DEFAULT_RUNNER_CPU=4
      - DEFAULT_RUNNER_MEMORY=8
      - DEFAULT_RUNNER_DISK=50
      - DEFAULT_RUNNER_NAME=default
      - DEFAULT_REGION_ID=us
      - DEFAULT_REGION_NAME=us
      - DEFAULT_REGION_ENFORCE_QUOTAS=false
      - DEFAULT_ORG_QUOTA_TOTAL_CPU_QUOTA=10000
      - DEFAULT_ORG_QUOTA_TOTAL_MEMORY_QUOTA=10000
      - DEFAULT_ORG_QUOTA_TOTAL_DISK_QUOTA=100000
      - DEFAULT_ORG_QUOTA_MAX_CPU_PER_SANDBOX=100
      - DEFAULT_ORG_QUOTA_MAX_MEMORY_PER_SANDBOX=100
      - DEFAULT_ORG_QUOTA_MAX_DISK_PER_SANDBOX=1000
      - DEFAULT_ORG_QUOTA_SNAPSHOT_QUOTA=1000
      - DEFAULT_ORG_QUOTA_MAX_SNAPSHOT_SIZE=1000
      - DEFAULT_ORG_QUOTA_VOLUME_QUOTA=10000
      - SSH_GATEWAY_API_KEY=${DAYTONA_SSH_SECRET:-ssh_secret_api_token}
      - SSH_GATEWAY_COMMAND=ssh -p 2222 {{TOKEN}}@localhost
      - SSH_GATEWAY_PUBLIC_KEY=
      - SSH_GATEWAY_URL=localhost:2222
      - SKIP_USER_EMAIL_VERIFICATION=true
      - RUN_MIGRATIONS=true
    restart: always
    privileged: true
    depends_on:
      - daytona-db
      - daytona-runner
      - daytona-redis
      - daytona-dex
      - daytona-registry

  daytona-proxy:
    image: daytonaio/daytona-proxy
    network_mode: 'service:daytona-network-service'
    environment:
      - DAYTONA_API_URL=http://localhost:3000/api
      - PROXY_PORT=4000
      - PROXY_API_KEY=${DAYTONA_PROXY_SECRET:-super_secret_key}
      - PROXY_PROTOCOL=http
      - OIDC_CLIENT_ID=daytona
      - OIDC_CLIENT_SECRET=
      - OIDC_DOMAIN=http://localhost:5556/dex
      - OIDC_PUBLIC_DOMAIN=http://localhost:${DAYTONA_DEX_PORT:-15556}/dex
      - OIDC_AUDIENCE=daytona
      - REDIS_HOST=localhost
      - REDIS_PORT=6379
      - TOOLBOX_ONLY_MODE=false
      - PREVIEW_WARNING_ENABLED=false
    restart: always
    depends_on:
      - daytona-api

  daytona-runner:
    image: daytonaio/daytona-runner
    network_mode: 'service:daytona-network-service'
    environment:
      - ENVIRONMENT=development
      - API_PORT=3003
      - DAYTONA_RUNNER_TOKEN=${DAYTONA_RUNNER_SECRET:-secret_api_token}
      - LOG_FILE_PATH=/home/daytona/runner/runner.log
      - RESOURCE_LIMITS_DISABLED=true
      - AWS_ENDPOINT_URL=http://localhost:9000
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_DEFAULT_BUCKET=daytona
      - DAYTONA_API_URL=http://localhost:3000/api
      - RUNNER_DOMAIN=localhost
      - SSH_GATEWAY_ENABLE=false
    privileged: true
    restart: always
    depends_on:
      - daytona-minio

  # SSH gateway disabled — not needed for programmatic sandbox access.
  # To enable, provide SSH_PRIVATE_KEY and SSH_HOST_KEY (base64-encoded) and set replicas: 1.
  daytona-ssh-gateway:
    image: daytonaio/daytona-ssh-gateway
    network_mode: 'service:daytona-network-service'
    deploy:
      replicas: 0
    environment:
      - API_URL=http://localhost:3000/api
      - API_KEY=${DAYTONA_SSH_SECRET:-ssh_secret_api_token}
      - SSH_PRIVATE_KEY=
      - SSH_HOST_KEY=
      - SSH_GATEWAY_PORT=2222
    restart: always
    depends_on:
      - daytona-api

  daytona-dex:
    image: dexidp/dex:v2.42.0
    network_mode: 'service:daytona-network-service'
    volumes:
      - ../infra/daytona/dex/config.yaml:/etc/dex/config.yaml
      - daytona-dex-db:/var/dex
    entrypoint: ['sh', '-c', 'touch /var/dex/dex.db && exec dex serve /etc/dex/config.yaml']
    healthcheck:
      test: ['CMD', 'wget', '--spider', '--quiet', 'http://localhost:5556/dex/.well-known/openid-configuration']

  daytona-db:
    image: postgres:18
    network_mode: 'service:daytona-network-service'
    environment:
      - POSTGRES_PASSWORD=pass
      - POSTGRES_USER=user
      - POSTGRES_DB=daytona
    volumes:
      - daytona-db-data:/var/lib/postgresql/18/docker

  daytona-redis:
    image: redis:latest
    network_mode: 'service:daytona-network-service'

  daytona-registry:
    image: registry:2.8.2
    network_mode: 'service:daytona-network-service'
    restart: always
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: 'true'
      REGISTRY_HTTP_ADDR: 0.0.0.0:6000
    volumes:
      - daytona-registry:/var/lib/registry

  daytona-minio:
    image: minio/minio:latest
    network_mode: 'service:daytona-network-service'
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_IDENTITY_STS_EXPIRY=24h
    volumes:
      - daytona-minio-data:/data
    command: server /data --console-address ":9001"

  daytona-otel-collector:
    image: otel/opentelemetry-collector-contrib:0.138.0
    network_mode: 'service:daytona-network-service'
    volumes:
      - ../infra/daytona/otel/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml

volumes:
  daytona-db-data:
    driver: local
  daytona-dex-db:
    driver: local
  daytona-registry:
    driver: local
  daytona-minio-data:
    driver: local

networks:
  daytona-network:
    driver: bridge
