name: Send Feishu Notification

on:
  pull_request:
    types: [opened, closed, reopened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send to Feishu
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUMBER="${{ github.event.number }}"
          PR_STATE="${{ github.event.action }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          REPO_URL="${{ github.event.repository.html_url }}"
          cat <<EOF >/tmp/feishu-card.json
            {
              "msg_type": "interactive",
              "card": {
                "config": {
                  "wide_screen_mode": true
                },
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "PR ÈÄöÁü•"
                  },
                  "template": "purple"
                },
                "elements": [
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": false,
                        "text": {
                          "tag": "lark_md",
                          "content": "‚ú® **${PR_TITLE}**"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "plain_text",
                          "content": "PR #${PR_NUMBER}"
                        }
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "Áî± **${PR_AUTHOR}** ÂèëËµ∑ ¬∑ ÂàÜÊîØÔºö**${BASE_REF} -> ${HEAD_REF}**"
                    }
                  },
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "Áä∂ÊÄÅÔºöüîî **${PR_STATE}**"
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "lark_md",
                          "content": "‰ΩúËÄÖÔºö**${PR_AUTHOR}**"
                        }
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "ÂΩìÂâçÂä®‰ΩúÔºö**${PR_STATE}**ÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ"
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "Êü•Áúã PR"
                        },
                        "type": "primary",
                        "url": "${PR_URL}"
                      },
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "‰ªìÂ∫ì‰∏ªÈ°µ"
                        },
                        "type": "default",
                        "url": "${REPO_URL}"
                      }
                    ]
                  }
                ]
              }
            }
          EOF
          curl -X POST -H "Content-Type: application/json" -d @/tmp/feishu-card.json https://open.feishu.cn/open-apis/bot/v2/hook/8f2abf06-2296-44fd-a000-c66ff4d464fe
