name: Send Feishu Notification

on:
  pull_request:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send to Feishu
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          PAYLOAD=$(jq -n \
            --arg msg_type "interactive" \
            --arg title "PR é€šçŸ¥" \
            --arg pr_title "${{ github.event.pull_request.title }}" \
            --arg pr_number "${{ github.event.number }}" \
            --arg pr_author "${{ github.event.pull_request.user.login }}" \
            --arg base_ref "${{ github.event.pull_request.base.ref }}" \
            --arg head_ref "${{ github.event.pull_request.head.ref }}" \
            --arg pr_state "${{ github.event.action }}" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg repo_url "${{ github.event.repository.html_url }}" \
            '{
              "msg_type": $msg_type,
              "card": {
                "config": {
                  "wide_screen_mode": true
                },
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": $title
                  },
                  "template": "purple"
                },
                "elements": [
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": false,
                        "text": {
                          "tag": "lark_md",
                          "content": ("âœ¨ " + $pr_title)
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "plain_text",
                          "content": ("PR #" + $pr_number)
                        }
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "plain_text",
                      "content": ("ç”± " + $pr_author + " å‘èµ· Â· åˆ†æ”¯ï¼š" + $base_ref + " -> " + $head_ref)
                    }
                  },
                  {
                    "tag": "div",
                    "fields": [
                      {
                        "is_short": true,
                        "text": {
                          "tag": "plain_text",
                          "content": ("çŠ¶æ€ï¼šğŸ”” " + $pr_state)
                        }
                      },
                      {
                        "is_short": true,
                        "text": {
                          "tag": "plain_text",
                          "content": ("ä½œè€…ï¼š" + $pr_author)
                        }
                      }
                    ]
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": ("å½“å‰åŠ¨ä½œï¼š" + $pr_state + "ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚")
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "æŸ¥çœ‹ PR"
                        },
                        "type": "primary",
                        "url": $pr_url
                      },
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "ä»“åº“ä¸»é¡µ"
                        },
                        "type": "default",
                        "url": $repo_url
                      }
                    ]
                  }
                ]
              }
            }')
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$FEISHU_WEBHOOK_URL"
